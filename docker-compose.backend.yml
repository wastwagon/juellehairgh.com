version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    container_name: juelle-hair-backend-prod
    environment:
      # Pass raw connection details to allow robust URL construction
      # This fixes issues with special characters in passwords (e.g. @)
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-juellehair}
      POSTGRES_HOST: ${POSTGRES_HOST:?POSTGRES_HOST is required}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      # DATABASE_URL: Use from Coolify's .env file (has pool parameters)
      # Entrypoint script will ensure pool parameters are always present
      DATABASE_URL: ${DATABASE_URL}
      PORT: 3001
      NODE_ENV: production
    ports:
      - "3001:3001"
    volumes:
      - backend_uploads:/app/uploads
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3001 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 300s
    networks:
      - coolify
    restart: unless-stopped

volumes:
  backend_uploads:
    driver: local

networks:
  coolify:
    external: true
